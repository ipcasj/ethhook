name: Production Deployment

# Deploy to DigitalOcean production server
# Required secrets:
# - DROPLET_HOST (IP address: 104.248.15.178)
# - DROPLET_USER (SSH username)
# - DROPLET_SSH_KEY (Private SSH key for authentication)
# Services run on: admin-api:3000, UI:3002, event-ingestor:8080

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual deployment

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DROPLET_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DROPLET_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to DigitalOcean Droplet
        run: |
          ssh -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -i ~/.ssh/deploy_key ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }} << 'ENDSSH'
            set -e
            echo "ðŸš€ Starting deployment to production..."
            
            # Navigate to project directory
            cd ~/ethhook || cd ~/rust_projects/capstone0 || cd ~/capstone0
            
            # Pull latest code
            echo "ðŸ“¥ Pulling latest code from main branch..."
            git fetch origin
            git reset --hard origin/main
            
            # Clean up old Docker resources to save space
            echo "ðŸ§¹ Cleaning up old Docker images..."
            docker image prune -f || true
            
            # Stop services
            echo "ðŸ›‘ Stopping services..."
            docker compose -f docker-compose.prod.yml down || true
            
            # Rebuild images (use cache to speed up builds)
            echo "ðŸ”¨ Building Docker images..."
            docker compose -f docker-compose.prod.yml build
            
            # Run migrations
            echo "ðŸ—ƒï¸  Running database migrations..."
            docker compose -f docker-compose.prod.yml run --rm admin-api sqlx migrate run || true
            
            # Start services
            echo "â–¶ï¸  Starting services..."
            docker compose -f docker-compose.prod.yml up -d
            
            # Wait for services to be healthy
            echo "â³ Waiting for services to start..."
            sleep 20
            
            # Check service status
            echo "ðŸ“Š Service status:"
            docker compose -f docker-compose.prod.yml ps
            
            # Verify containers are running
            echo "ðŸ” Verifying containers..."
            if ! docker ps | grep -q "ethhook-admin-api"; then
              echo "âš ï¸  WARNING: admin-api container not running!"
              docker logs ethhook-admin-api --tail=20 || true
            fi
            
            echo "âœ… Deployment complete!"
          ENDSSH
      
      - name: Health Check
        run: |
          echo "ðŸ¥ Running health checks..."
          
          # Check API health endpoint (admin-api runs on port 3000)
          max_attempts=10
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt/$max_attempts: Checking API health..."
            
            if curl -f -s "http://${{ secrets.DROPLET_HOST }}:3000/api/v1/health" > /dev/null; then
              echo "âœ… API is healthy!"
              break
            fi
            
            if [ $attempt -eq $max_attempts ]; then
              echo "âŒ Health check failed after $max_attempts attempts"
              exit 1
            fi
            
            echo "Waiting 10 seconds before retry..."
            sleep 10
            attempt=$((attempt + 1))
          done
          
          # Check UI is accessible (UI runs on port 3002)
          echo "Checking UI accessibility..."
          if curl -f -s "http://${{ secrets.DROPLET_HOST }}:3002/" > /dev/null; then
            echo "âœ… UI is accessible!"
          else
            echo "âš ï¸  UI health check failed (this may be OK if UI is still starting)"
          fi
      
      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
      
      - name: Deployment Summary
        if: success()
        run: |
          echo "## ðŸŽ‰ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ secrets.PRODUCTION_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All services are running and healthy âœ…" >> $GITHUB_STEP_SUMMARY
      
      - name: Notify on Failure
        if: failure()
        run: |
          echo "## âŒ Deployment Failed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The deployment encountered errors. Please check the logs above." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Rollback:** Use the 'Rollback' workflow to revert to previous version." >> $GITHUB_STEP_SUMMARY

  rollback:
    name: Rollback (Manual)
    runs-on: ubuntu-latest
    if: failure() && github.event_name == 'workflow_dispatch'
    needs: deploy
    
    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DROPLET_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DROPLET_HOST }} >> ~/.ssh/known_hosts
      
      - name: Rollback to previous version
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }} << 'ENDSSH'
            set -e
            echo "âª Rolling back to previous version..."
            
            cd ~/ethhook || cd ~/rust_projects/capstone0 || cd ~/capstone0
            
            # Get previous commit
            git reset --hard HEAD~1
            
            # Rebuild and restart
            docker-compose -f docker-compose.prod.yml down || docker compose -f docker-compose.prod.yml down
            docker-compose -f docker-compose.prod.yml up -d || docker compose -f docker-compose.prod.yml up -d
            
            echo "âœ… Rollback complete!"
          ENDSSH
      
      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
