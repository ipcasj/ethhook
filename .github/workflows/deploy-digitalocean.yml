name: Deploy to DigitalOcean

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual triggering

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/ipcasj/ethhook

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: Check deployment configuration
        id: check-config
        run: |
          if [ -z "${{ secrets.DROPLET_HOST }}" ] || [ -z "${{ secrets.DROPLET_SSH_KEY }}" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Deployment skipped: DROPLET_HOST or DROPLET_SSH_KEY secrets not configured"
            echo ""
            echo "To enable automated deployment:"
            echo "1. Go to Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "2. Add DROPLET_HOST (your server IP)"
            echo "3. Add DROPLET_SSH_KEY (your SSH private key)"
            exit 0
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "‚úì Deployment configuration found"
          fi

      - name: Checkout code
        if: steps.check-config.outputs.skip == 'false'
        uses: actions/checkout@v4

      - name: Setup SSH key
        if: steps.check-config.outputs.skip == 'false'
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DROPLET_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DROPLET_HOST }} >> ~/.ssh/known_hosts

      - name: Setup project directory on server
        if: steps.check-config.outputs.skip == 'false'
        run: |
          ssh ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }} << 'EOF'
            # Create project directory if it doesn't exist
            if [ ! -d ~/ethhook ]; then
              echo "Creating ~/ethhook directory..."
              mkdir -p ~/ethhook
              cd ~/ethhook
              git clone https://github.com/ipcasj/ethhook.git .
              echo "‚úÖ Repository cloned"
            else
              echo "‚úÖ Directory exists"
              cd ~/ethhook
              git pull origin main
              echo "‚úÖ Repository updated"
            fi
          EOF

      - name: Configure environment variables on server
        if: steps.check-config.outputs.skip == 'false'
        run: |
          # Create production .env file
          cat > /tmp/prod.env << 'PRODENV'
          # ETHHOOK PRODUCTION CONFIGURATION
          
          # Database
          DATABASE_URL=sqlite:/data/config.db
          DATABASE_MAX_CONNECTIONS=20
          DATABASE_MIN_CONNECTIONS=5
          
          # Environment
          ENVIRONMENT=production
          
          # Ethereum RPC (Mainnet)
          ETHEREUM_RPC_URL=https://eth-mainnet.g.alchemy.com/v2/xGCBQXSFxK8qbIwCcSaJW
          ETHEREUM_WS_URL=wss://eth-mainnet.g.alchemy.com/v2/xGCBQXSFxK8qbIwCcSaJW
          
          # L2 Chains
          ARBITRUM_RPC_URL=https://arb-mainnet.g.alchemy.com/v2/ddFFnbN_vc-tyIXEsIgzN
          ARBITRUM_WS_URL=wss://arb-mainnet.g.alchemy.com/v2/ddFFnbN_vc-tyIXEsIgzN
          
          OPTIMISM_RPC_URL=https://opt-mainnet.g.alchemy.com/v2/2wYIA1B8CW11Q9s9QSBUq
          OPTIMISM_WS_URL=wss://opt-mainnet.g.alchemy.com/v2/2wYIA1B8CW11Q9s9QSBUq
          
          BASE_RPC_URL=https://base-mainnet.g.alchemy.com/v2/Q5Todg2C3lLAHDaYBmS8a
          BASE_WS_URL=wss://base-mainnet.g.alchemy.com/v2/Q5Todg2C3lLAHDaYBmS8a
          
          # Security
          JWT_SECRET=o6MANa5PpM3GDXgwqxrOdaymq0PhMxKzFXjbdOJCy4
          JWT_EXPIRATION_HOURS=24
          
          # Service Configuration
          WORKER_COUNT=50
          RUST_LOG=info,ethhook=info,sqlx=warn
          
          # API
          API_HOST=0.0.0.0
          API_PORT=3000
          
          # Webhooks
          WEBHOOK_TIMEOUT_SECONDS=30
          WEBHOOK_MAX_RETRIES=5
          WEBHOOK_WORKER_THREADS=50
          
          # CORS
          CORS_ALLOWED_ORIGINS=*
          
          # Metrics
          PROMETHEUS_METRICS_PORT=9090
          
          # Grafana
          GRAFANA_PASSWORD=admin
          PRODENV
          
          # Add secret from GitHub Secrets
          echo "" >> /tmp/prod.env
          echo "# Secrets" >> /tmp/prod.env
          echo "CLICKHOUSE_PASSWORD=${{ secrets.CLICKHOUSE_PASSWORD }}" >> /tmp/prod.env
          
          # Verify file
          echo "üìù Production .env file created ($(wc -l < /tmp/prod.env) lines)"
          
          # Copy to server
          scp /tmp/prod.env ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }}:~/ethhook/.env
          
          # Verify on server
          ssh ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }} << 'EOF'
            cd ~/ethhook
            
            if [ -f .env ]; then
              echo "‚úÖ .env file exists ($(wc -l < .env) lines)"
              echo "Key variables:"
              grep -E "^(DATABASE_URL|CLICKHOUSE_PASSWORD|JWT_SECRET|ETHEREUM_WS_URL)=" .env | sed 's/=.*/=***/'
            else
              echo "‚ùå .env file not found!"
              exit 1
            fi
          EOF
          
          # Cleanup
          rm /tmp/prod.env
          
          echo "‚úÖ Production environment configured"

      - name: Build and push Docker images
        if: steps.check-config.outputs.skip == 'false'
        run: |
          # Login to GitHub Container Registry
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # Build and push images
          echo "Building and pushing Docker images..."
          docker compose -f docker-compose.prod.yml build pipeline admin-api ui demo-webhook-receiver
          docker compose -f docker-compose.prod.yml push pipeline admin-api ui demo-webhook-receiver
          
          echo "‚úÖ Docker images built and pushed"

      - name: Pull latest images on server
        if: steps.check-config.outputs.skip == 'false'
        run: |
          ssh ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }} << 'EOF'
            cd ~/ethhook
            
            # Login to GitHub Container Registry
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # Pull latest images
            docker compose -f docker-compose.prod.yml pull pipeline admin-api ui demo-webhook-receiver
            
            echo "‚úÖ Latest images pulled successfully"
          EOF

      - name: Deploy services
        if: steps.check-config.outputs.skip == 'false'
        run: |
          ssh ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }} << 'EOF'
            cd ~/ethhook
            
            # Verify .env file exists and has content
            if [ -f .env ]; then
              echo "‚úÖ .env file exists ($(wc -l < .env) lines)"
              echo "Environment variables configured:"
              grep -E "^[A-Z_]+=" .env | sed 's/=.*/=***/'
            else
              echo "‚ùå .env file not found!"
              exit 1
            fi
            
            # Stop all services gracefully
            echo "Stopping existing services..."
            docker compose -f docker-compose.prod.yml down || true
            
            # Start ClickHouse first (it's a dependency)
            echo "Starting ClickHouse database..."
            docker compose -f docker-compose.prod.yml up -d clickhouse
            
            # Wait for ClickHouse to be healthy
            echo "Waiting for ClickHouse to be healthy..."
            sleep 10
            
            # Start application services
            echo "Starting application services..."
            docker compose -f docker-compose.prod.yml up -d pipeline admin-api ui demo-webhook-receiver
            
            # Check what was started
            echo ""
            echo "=== Checking started containers ==="
            docker ps -a --filter "name=ethhook"
            
            echo ""
            echo "=== Docker Compose Services Status ==="
            docker compose -f docker-compose.prod.yml ps
            
            echo "‚úÖ Services start command completed"
          EOF

      - name: Wait for services to be healthy
        if: steps.check-config.outputs.skip == 'false'
        run: |
          ssh ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }} << 'EOF'
            cd ~/ethhook
            
            echo "Waiting for services to become healthy..."
            sleep 15
            
            # Check service status with detailed output
            echo "=== Docker Compose Service Status ==="
            docker compose -f docker-compose.prod.yml ps -a
            
            echo ""
            echo "=== Running Containers ==="
            docker ps -a
            
            # Check if services are running
            if docker compose -f docker-compose.prod.yml ps | grep -q "Up"; then
              echo "‚úÖ Services are running"
            else
              echo "‚ùå Some services failed to start"
              echo ""
              echo "=== Service Logs (last 100 lines) ==="
              docker compose -f docker-compose.prod.yml logs --tail=100
              exit 1
            fi
          EOF

      - name: Verify API health
        if: steps.check-config.outputs.skip == 'false'
        run: |
          echo "Waiting for services to be fully ready..."
          sleep 10
          
          # Check admin API health (port 3000)
          echo "Checking admin API..."
          ADMIN_API_HEALTH=$(curl -f -s http://${{ secrets.DROPLET_HOST }}:3000/health || echo "failed")
          if [ "$ADMIN_API_HEALTH" = "failed" ]; then
            echo "‚ùå Admin API health check failed (port 3000)"
            ssh ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }} "docker logs ethhook-admin-api --tail=50"
            exit 1
          else
            echo "‚úÖ Admin API is healthy: $ADMIN_API_HEALTH"
          fi
          
          # Check pipeline health (port 8080)
          echo "Checking pipeline service..."
          PIPELINE_HEALTH=$(curl -f -s http://${{ secrets.DROPLET_HOST }}:8080/health || echo "failed")
          if [ "$PIPELINE_HEALTH" = "failed" ]; then
            echo "‚ö†Ô∏è  Pipeline health check failed (port 8080) - may still be starting"
          else
            echo "‚úÖ Pipeline is healthy: $PIPELINE_HEALTH"
          fi

      - name: Cleanup old Docker images
        if: steps.check-config.outputs.skip == 'false'
        run: |
          ssh ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }} << 'EOF'
            # Remove dangling images to save space
            docker image prune -f
            echo "‚úÖ Cleaned up old Docker images"
          EOF

      - name: Deployment notification
        if: always() && steps.check-config.outputs.skip == 'false'
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ Deployment to DigitalOcean successful!"
            echo "üöÄ Services: pipeline, admin-api, ui, demo-webhook-receiver"
            echo "üåê Server: ${{ secrets.DROPLET_HOST }}"
            echo "üîó Production URL: ${{ secrets.PRODUCTION_URL }}"
          else
            echo "‚ùå Deployment failed. Check logs above."
          fi
