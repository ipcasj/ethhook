name: Deploy to DigitalOcean

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual triggering

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/ipcasj/ethhook

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: Check deployment configuration
        id: check-config
        run: |
          if [ -z "${{ secrets.DROPLET_HOST }}" ] || [ -z "${{ secrets.DROPLET_SSH_KEY }}" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Deployment skipped: DROPLET_HOST or DROPLET_SSH_KEY secrets not configured"
            echo ""
            echo "To enable automated deployment:"
            echo "1. Go to Settings â†’ Secrets and variables â†’ Actions"
            echo "2. Add DROPLET_HOST (your server IP)"
            echo "3. Add DROPLET_SSH_KEY (your SSH private key)"
            exit 0
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "âœ“ Deployment configuration found"
          fi

      - name: Checkout code
        if: steps.check-config.outputs.skip == 'false'
        uses: actions/checkout@v4

      - name: Setup SSH key
        if: steps.check-config.outputs.skip == 'false'
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DROPLET_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DROPLET_HOST }} >> ~/.ssh/known_hosts

      - name: Pull latest images on server
        if: steps.check-config.outputs.skip == 'false'
        run: |
          ssh ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }} << 'EOF'
            cd ~/ethhook
            
            # Login to GitHub Container Registry
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # Pull latest images
            docker compose -f docker-compose.prod.yml pull pipeline admin-api ui demo-webhook-receiver
            
            echo "âœ… Latest images pulled successfully"
          EOF

      - name: Deploy services
        if: steps.check-config.outputs.skip == 'false'
        run: |
          ssh ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }} << 'EOF'
            cd ~/ethhook
            
            # Stop services gracefully
            docker compose -f docker-compose.prod.yml stop pipeline admin-api ui demo-webhook-receiver
            
            # Remove old containers
            docker compose -f docker-compose.prod.yml rm -f pipeline admin-api ui demo-webhook-receiver
            
            # Start updated services
            docker compose -f docker-compose.prod.yml up -d pipeline admin-api ui demo-webhook-receiver
            
            echo "âœ… Services restarted with latest images"
          EOF

      - name: Wait for services to be healthy
        if: steps.check-config.outputs.skip == 'false'
        run: |
          ssh ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }} << 'EOF'
            echo "Waiting for services to become healthy..."
            sleep 10
            
            # Check service status
            docker compose -f ~/ethhook/docker-compose.prod.yml ps
            
            # Check if services are running
            if docker compose -f ~/ethhook/docker-compose.prod.yml ps | grep -q "Up"; then
              echo "âœ… Services are running"
            else
              echo "âŒ Some services failed to start"
              docker compose -f ~/ethhook/docker-compose.prod.yml logs --tail=50
              exit 1
            fi
          EOF

      - name: Verify API health
        if: steps.check-config.outputs.skip == 'false'
        run: |
          sleep 5
          HEALTH_CHECK=$(curl -f -s http://${{ secrets.DROPLET_HOST }}:3001/health || echo "failed")
          if [ "$HEALTH_CHECK" = "failed" ]; then
            echo "âŒ API health check failed"
            exit 1
          else
            echo "âœ… API is healthy: $HEALTH_CHECK"
          fi

      - name: Cleanup old Docker images
        if: steps.check-config.outputs.skip == 'false'
        run: |
          ssh ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }} << 'EOF'
            # Remove dangling images to save space
            docker image prune -f
            echo "âœ… Cleaned up old Docker images"
          EOF

      - name: Deployment notification
        if: always() && steps.check-config.outputs.skip == 'false'
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Deployment to DigitalOcean successful!"
            echo "ðŸš€ Services: pipeline, admin-api, ui, demo-webhook-receiver"
            echo "ðŸŒ Server: ${{ secrets.DROPLET_HOST }}"
            echo "ðŸ”— Production URL: ${{ secrets.PRODUCTION_URL }}"
          else
            echo "âŒ Deployment failed. Check logs above."
          fi
