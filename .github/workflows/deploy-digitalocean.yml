name: Deploy to DigitalOcean

on:
    workflow_run:
        workflows: ["CI"]
        types:
            - completed
        branches:
            - main
    workflow_dispatch: # Allow manual triggering

env:
    REGISTRY: ghcr.io
    IMAGE_PREFIX: ghcr.io/ipcasj/ethhook

jobs:
    deploy:
        name: Deploy to Production
        runs-on: ubuntu-latest
        # Only deploy if CI passed and on main branch
        if: |
            github.event.workflow_run.conclusion == 'success' && 
            github.event.workflow_run.head_branch == 'main' ||
            github.event_name == 'workflow_dispatch'

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup SSH key
              run: |
                  mkdir -p ~/.ssh
                  echo "${{ secrets.DO_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
                  chmod 600 ~/.ssh/id_rsa
                  ssh-keyscan -H ${{ secrets.DO_HOST }} >> ~/.ssh/known_hosts

            - name: Pull latest images on server
              run: |
                  ssh root@${{ secrets.DO_HOST }} << 'EOF'
                    cd ~/ethhook
                    
                    # Login to GitHub Container Registry
                    echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
                    
                    # Pull latest images
                    docker compose -f docker-compose.prod.yml pull pipeline admin-api ui demo-webhook-receiver
                    
                    echo "âœ… Latest images pulled successfully"
                  EOF

            - name: Deploy services
              run: |
                  ssh root@${{ secrets.DO_HOST }} << 'EOF'
                    cd ~/ethhook
                    
                    # Stop services gracefully
                    docker compose -f docker-compose.prod.yml stop pipeline admin-api ui demo-webhook-receiver
                    
                    # Remove old containers
                    docker compose -f docker-compose.prod.yml rm -f pipeline admin-api ui demo-webhook-receiver
                    
                    # Start updated services
                    docker compose -f docker-compose.prod.yml up -d pipeline admin-api ui demo-webhook-receiver
                    
                    echo "âœ… Services restarted with latest images"
                  EOF

            - name: Wait for services to be healthy
              run: |
                  ssh root@${{ secrets.DO_HOST }} << 'EOF'
                    echo "Waiting for services to become healthy..."
                    sleep 10
                    
                    # Check service status
                    docker compose -f ~/ethhook/docker-compose.prod.yml ps
                    
                    # Check if services are running
                    if docker compose -f ~/ethhook/docker-compose.prod.yml ps | grep -q "Up"; then
                      echo "âœ… Services are running"
                    else
                      echo "âŒ Some services failed to start"
                      docker compose -f ~/ethhook/docker-compose.prod.yml logs --tail=50
                      exit 1
                    fi
                  EOF

            - name: Verify API health
              run: |
                  sleep 5
                  HEALTH_CHECK=$(curl -f -s http://${{ secrets.DO_HOST }}:3001/health || echo "failed")
                  if [ "$HEALTH_CHECK" = "failed" ]; then
                    echo "âŒ API health check failed"
                    exit 1
                  else
                    echo "âœ… API is healthy: $HEALTH_CHECK"
                  fi

            - name: Cleanup old Docker images
              run: |
                  ssh root@${{ secrets.DO_HOST }} << 'EOF'
                    # Remove dangling images to save space
                    docker image prune -f
                    echo "âœ… Cleaned up old Docker images"
                  EOF

            - name: Deployment notification
              if: always()
              run: |
                  if [ "${{ job.status }}" = "success" ]; then
                    echo "âœ… Deployment to DigitalOcean successful!"
                    echo "ðŸš€ Services: pipeline, admin-api, ui, demo-webhook-receiver"
                    echo "ðŸŒ Server: ${{ secrets.DO_HOST }}"
                  else
                    echo "âŒ Deployment failed. Check logs above."
                  fi
