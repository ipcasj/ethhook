name: C Implementation CI

on:
    push:
        branches: [main, develop]
        paths:
            - "ethhook-c/**"
            - ".github/workflows/ci-c.yml"
    pull_request:
        branches: [main, develop]
        paths:
            - "ethhook-c/**"
    workflow_dispatch: # Allow manual triggering

jobs:
    build-and-test:
        name: Build and Test C Services
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Install dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                    build-essential \
                    cmake \
                    pkg-config \
                    libsqlite3-dev \
                    libhiredis-dev \
                    libmicrohttpd-dev \
                    libcurl4-openssl-dev \
                    libssl-dev \
                    libevent-dev \
                    libwebsockets-dev \
                    cppcheck \
                    valgrind

            - name: Build C services
              run: |
                  cd ethhook-c
                  mkdir -p build && cd build
                  cmake -DCMAKE_BUILD_TYPE=Release -DENABLE_LTO=ON ..
                  make -j$(nproc)

            - name: Run static analysis (cppcheck)
              run: |
                  cd ethhook-c
                  cppcheck --enable=warning,style,performance,portability \
                           --error-exitcode=0 \
                           --suppress=missingIncludeSystem \
                           --suppress=preprocessorErrorDirective:src/common/yyjson.c \
                           --suppress=missingInclude \
                           --inline-suppr \
                           -i src/common/yyjson.c \
                           src/ 2>&1 | tee cppcheck-quick.txt
                  
                  # Only fail on actual errors in our code (not third-party libs or style warnings)
                  if grep -E "^src/.*(admin-api|ingestor|processor|delivery)/.*: error:" cppcheck-quick.txt; then
                    echo "❌ Critical errors found in cppcheck"
                    exit 1
                  fi
                  
                  # Show style warnings but don't fail
                  STYLE_WARNINGS=$(grep -c "style:" cppcheck-quick.txt || true)
                  if [ "$STYLE_WARNINGS" -gt 0 ]; then
                    echo "⚠️  $STYLE_WARNINGS style warnings found (non-blocking)"
                  fi
                  
                  echo "✅ Static analysis passed"

            - name: Verify binary sizes
              run: |
                  cd ethhook-c/build
                  ls -lh ethhook-* | awk '{print $9, $5}'

                  # Verify binaries are reasonable size (< 500KB each)
                  for binary in ethhook-admin-api ethhook-ingestor ethhook-processor ethhook-delivery; do
                    size=$(stat -c%s $binary)
                    if [ $size -gt 524288 ]; then
                      echo "❌ $binary is too large: $size bytes (> 512KB)"
                      exit 1
                    fi
                    echo "✅ $binary: $size bytes"
                  done

            - name: Run unit tests (if available)
              run: |
                  cd ethhook-c/build
                  # Add test execution here when tests are available
                  echo "✅ Tests placeholder (add actual tests later)"

            - name: Build with sanitizers
              run: |
                  cd ethhook-c
                  mkdir -p build-sanitizers && cd build-sanitizers
                  cmake -DCMAKE_BUILD_TYPE=Debug \
                        -DENABLE_ASAN=ON \
                        -DENABLE_UBSAN=ON \
                        ..
                  make -j$(nproc)

    docker-build:
        name: Build Docker Images
        runs-on: ubuntu-latest
        needs: build-and-test

        steps:
            - uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build admin-api image
              run: |
                  cd ethhook-c
                  docker build -f docker/Dockerfile.admin-api -t ethhook-c-admin-api:test .

            - name: Build ingestor image
              run: |
                  cd ethhook-c
                  docker build -f docker/Dockerfile.ingestor -t ethhook-c-ingestor:test .

            - name: Build processor image
              run: |
                  cd ethhook-c
                  docker build -f docker/Dockerfile.processor -t ethhook-c-processor:test .

            - name: Build delivery image
              run: |
                  cd ethhook-c
                  docker build -f docker/Dockerfile.delivery -t ethhook-c-delivery:test .

            - name: Test Docker images startup
              run: |
                  # Quick smoke test - verify images can start
                  docker run --rm ethhook-c-admin-api:test --version || echo "Version flag not implemented"
                  echo "✅ Docker images built successfully"

    security-audit:
        name: Security Audit
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Install security tools
              run: |
                  sudo apt-get update
                  sudo apt-get install -y cppcheck clang-tools

            - name: Run cppcheck with all checks
              run: |
                  cd ethhook-c
                  cppcheck --enable=all \
                           --suppress=missingIncludeSystem \
                           --suppress=unusedFunction \
                           --suppress=preprocessorErrorDirective:src/common/yyjson.c \
                           --suppress=missingInclude \
                           --inline-suppr \
                           --error-exitcode=0 \
                           -i src/common/yyjson.c \
                           src/ 2>&1 | tee cppcheck-report.txt

            - name: Check for security-critical issues
              run: |
                  cd ethhook-c
                  # Fail only if critical security issues found (not filenames or style warnings)
                  # Look for actual cppcheck error severity markers
                  if grep -E "^src/.*: error: .*(buffer overflow|use after free|double free|null pointer|memory leak|uninitialized variable)" cppcheck-report.txt; then
                    echo "❌ Critical security issues found!"
                    exit 1
                  fi
                  
                  # Count any errors (excluding yyjson.c third-party lib)
                  ERROR_COUNT=$(grep -E "^src/(admin-api|ingestor|processor|delivery)/.*: error:" cppcheck-report.txt | wc -l || true)
                  if [ "$ERROR_COUNT" -gt 0 ]; then
                    echo "❌ Found $ERROR_COUNT error(s) in application code"
                    grep -E "^src/(admin-api|ingestor|processor|delivery)/.*: error:" cppcheck-report.txt
                    exit 1
                  fi
                  
                  echo "✅ No critical security issues detected"

            - name: Upload analysis reports
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: security-reports
                  path: ethhook-c/cppcheck-report.txt
